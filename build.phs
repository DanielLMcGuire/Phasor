using("stdsys", "stdtype", "stdio");

fn printHelp(program: string) -> int {
    printf("Usage: <runtime> %s [preset]\n", program);
    return sys_execute("cmake --list-presets");
}

fn configure(srcFolder: string, buildFolder: string, preset: string) -> bool {
    if (sys_execute(c_fmt("cmake -S %s -B %s --preset %s", srcFolder, buildFolder, preset)) != 0) {
        return true;
    }
    return false;
}

fn build(buildFolder: string) -> bool {
    if (sys_execute(c_fmt("cmake --build %s", buildFolder)) != 0) {
        return true;
    }
    return false;
}

fn install(buildFolder: string, prefixFolder: string) -> bool {
    if (sys_execute(c_fmt("cmake --install %s --prefix %s", buildFolder, prefixFolder)) != 0) {
        return true;
    }
    return false;
}

fn main() -> int {
    var preset;
    var install = true;
    if (sys_argc() > 1) { 
        preset = to_string(sys_argv(1)); 
    } else {
        if (printHelp(sys_argv(0)) != 0) return 1;
        return -1;
    }

    if (sys_argc() > 2) {
        if (to_string(sys_argv(2)) == "--no-install") {
            install = false;
        } else {
            if (printHelp(sys_argv(0)) != 0) return 1;
            return -1;
        }
    }

    if (!configure(".", "build", preset)) {
        printf("Configuration failed\n");
        return 1;
    }

    if (!build("build")) {
        printf("Build failed\n");
        return 1;
    }

    if (install && !install("build", "install")) {
        printf("Installation failed\n");
        return 1;
    }

    return 0;
}

shutdown(main());