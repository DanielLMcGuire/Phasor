using("stdio");
using("stdstr");
using("stdtype");
using("stdsys");
using("stdfile");

var logfile = "outfile.txt";

fn secondsToMinutes(seconds: float) -> string {
    if (seconds < 60) return c_fmt("%fs", seconds);
    if (seconds % 60 < 10) return c_fmt("%d:0%ds", seconds / 60, seconds % 60);
    return c_fmt("%d:%ds", seconds / 60, seconds % 60);
}

fn msToSeconds(milli: float) -> float {
    return milli / 1000;
}

fn rule110(width: int, generations: int, stdout: bool) -> int {
    if (!stdout) puts(concat("Output at ", logfile));
    frm(logfile);
    var start = time();

    var board_sb = sb_new();
    var i = 0;
    while (i < width - 1) {
        sb_append(board_sb, " ");
        i = i + 1;
    }
    sb_append(board_sb, "#");

    var board = sb_to_string(board_sb);
    sb_free(board_sb);

    var next_board = sb_new();
    var file_buffer = sb_new(); 
    var g = 0;

    if (!stdout) printf("GENERATION 0 TIME: %s", secondsToMinutes(msToSeconds(time() - start)));
    var l_start = time();
    var avg_amt = 0.0;
    var avg_gen = 0.0;
    var average = 0.0;
    var avg_remaining = 0.0;

    while (g <= generations) {
        if (stdout) { 
            puts(board);
        } 
    
        sb_append(file_buffer, board);
        sb_append(file_buffer, "\n");

        next_board = sb_new();

        var k = 0;
        while (k < width) {
                    var l = " ";
        if (k > 0)
            l = char_at(board, k - 1);
        var c = char_at(board, k);
        var r = " ";
        if (k < width - 1)
            r = char_at(board, k + 1);
        var next_val = " ";
        if ((c == "#" && r == " ") || (c == " " && r == "#") || (l == " " && c == "#" && r == "#"))
            next_val = "#";

        sb_append(next_board, next_val);
            k = k + 1;
        }

        if (g != 0 && (g % 500 == 0)) {
            var chunk = sb_to_string(file_buffer);
            fappend(logfile, chunk);
            sb_free(file_buffer);
            file_buffer = sb_new();

            if (!stdout) {
                var now = time();

                var chunk_time;
                chunk_time = msToSeconds(now - l_start);

                avg_amt = avg_amt + chunk_time;
                avg_gen = avg_gen + 1;

                average = avg_amt / avg_gen;

                var chunks_done;
                chunks_done = avg_gen;

                var chunks_total;
                chunks_total = generations / 500.0;

                avg_remaining = (chunks_total - chunks_done) * average;
				prints("\r                                                                        ");
                printf(
                    "\rGENERATION %d-%d TIME: %s, TOTAL: %s, ETA: %s",
                    (g - 499),
                    g,
                    secondsToMinutes(chunk_time),
                    secondsToMinutes(msToSeconds(now - start)),
                    secondsToMinutes(avg_remaining)
                );

                l_start = now;
            }

        }

        board = sb_to_string(next_board);
        sb_free(next_board);
        g = g + 1;
    }

    var final_chunk = sb_to_string(file_buffer);
    fappend(logfile, final_chunk);
    sb_free(file_buffer);

    sb_free(next_board);
    putf("\nTOTAL: %s", secondsToMinutes(msToSeconds(time() - start)));
    return 0;
}

if (sys_argc() < 4) shutdown(rule110(2085, 25050, false)); // Close to 1MB per block

shutdown(rule110(to_int(sys_argv(1)), to_int(sys_argv(2)), to_int(sys_argv(3))));
