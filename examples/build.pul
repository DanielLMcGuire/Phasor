using("stdsys", "stdio", "stdstr", "stdfile", "stdtype")

let conf = "build.conf"
let g_clean = false
let show_help = false

func printHelp() {
	putf(`
phasor %s [option] CONFIG 

    CONFIG      - Configuration File (defaults to build.conf)

Options:
    -c, --clean - Clean build files
    -h, --help  - Show this help message

Example Config File:
    in.phs
    out.phsb
    phasorcompiler
    --no-logo -o %%s %%s`, 
	sys_argv(0))

	if (fexists(conf)) {
		putf(`
Current Config:

    Source:   %s
    Binary:   %s
    Compiler: %s
    Flags:    %s
    Command:  %s`, 
	src, 
	dest, 
	comp, 
	args, 
	c_fmt("%s %s", comp, c_fmt(args, dest, src)))
	}
}

func build(src: string, dest: string, comp: string, args: string) -> bool {
    putf("Using compiler: %s\n\nBuilding Phasor Binary: %s -> %s", comp, src, dest)
    return to_bool(sys_execute(c_fmt("%s %s", comp, c_fmt(args, dest, src))))
}

if (sys_argc() >= 2) {
    var argument = sys_argv(1)
	if (argument == "--help" || argument == "-h") {
		show_help = true
	} else if (argument == "--clean" || argument == "-c") {
        g_clean = true
    } else {
		conf = argument
	}
	if (sys_argc() == 3)
		conf = sys_argv(2)
}

if (conf != null || conf != "") {
	src = freadln(conf, 0)  // 1 - Source File
	dest = freadln(conf, 1)  // 2 - Out File
    comp = freadln(conf, 2) // 3 - Compiler
    args = freadln(conf, 3) // 4 - Compiler Flags
} else {
	puts("Invalid configuration file!")
}

if (show_help) {
    printHelp()
    shutdown(0)
}

if (g_clean) {
    var stat = !frm(dest)
    putf("Cleaned %s", dest)
    shutdown(stat)
}

shutdown(!build(src, dest, comp, args))
