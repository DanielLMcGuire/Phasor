// Phasor Build Script
include_stdsys();
include_stdio();
include_stdstr();
include_stdfile();
include_stdtype();

var conf = "build.conf";
var g_clean = false;

fn printHelp() {
	putf(`
phasor %s [option] CONFIG 

    CONFIG      - Configuration File (defaults to build.conf)			

Options:
    -c, --clean - Clean build files
    -h, --help  - Show this help message
	
Configuration File Format:
    Line 1 - Source File (infile)
    Line 2 - Binary File (outfile)`, sys_argv(0));
}

fn l2i(index: int) -> int {return index - 1;}

fn buildPHSB(input: string, output: string) -> bool {
    putf("Building Phasor Binary: %s -> %s", input, output);
    return to_bool(sys_execute(c_fmt("phasorcompiler --no-logo -o %s %s", output, input)));
}

if (sys_argc() >= 2) {
	
    var argument = sys_argv(1);
	if (argument == "--help" || argument == "-h") {
		printHelp();
		shutdown(1);
	} else if (argument == "--clean" || argument == "-c") {
        g_clean = true;
    } else {
		conf = argument;
	}
	if (sys_argc() == 3)
		conf = sys_argv(2);
}

if (conf != null || conf != "") {
	var src = freadln(conf, l2i(1));
	var dst = freadln(conf, l2i(2)); 
} else {
	puts("Invalid configuration file!");
}

if (g_clean) {
    var stat = !frm(dst);
    putf("Cleaned %s", dst);
    shutdown(stat);
}

shutdown(!buildPHSB(src, dst));